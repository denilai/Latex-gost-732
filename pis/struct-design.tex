\chapter{ПРОЕКТИРОВАНИЕ ЦИФРОВОГО УСТРОЙСТВА}

\label{sec:design}
В данном разделе освещается разработка функциональной и структурной схем устройства по ресинхронизации данных. 
Определим структурные элементы устройства, принцип и порядок его работы.

\section{Организация взаимодействия с устройством}
Взаимодействие с устройством производится посредством передачи восьмибитного слова на вход wdata. Аппаратный блок осуществляет запись данных во внутреннюю память по сигналам тактового генератора домена источника данных wclk, основываясь на состоянии входных сигналов wrst, wen и служебных сигналов wr\_full,  wptr, rptr.

Чтение из устройства ресинхронизации производится посредством считывания тридцатидвухразрядного слова, составляемого из четырех последовательно поданных на вход восьмиразрядных слов в порядке \textit{от старшего к младшему} (англ. big-endian), генерируемого на выходе rdata. Аппаратный блок осуществляет чтение данных из внутренней памяти по сигналам тактового генератора домена получателя данных, основываясь на состоянии входных сигналов rrst, ren  r\_empty wptr, rptr, rdredy.

\section{Организация памяти}

Устройство хранит данные в собственной памяти. Устройство может одновременно хранить шестнадцать восьмибитных слов, используя для их адресации пятиразрядный адрес, в котором старший бит призван реализовать возможность контроля заполнения и опустошения очереди. 

Возможность асинхронного сброса памяти не реализована в силу того, что обычно память в устройствах, реализуемых на ПЛИС представлена в виде блочной оперативной памяти и выделенной оперативной памяти. Эти ресурсы обычно не поддерживают сброс. Сброс возможно реализовать в регистрах. 



\section{Тактирование}
Управление устройством производится по двух синхросигналам wclk и rclk. С целью оптимальной работы цифрового устройства при передаче данных из одного домена синхросигнала в другой тактовые сигналы входного и выходного каналов сделаны независимыми, однако тактовая частота для выхода очереди составляет как минимум $\dfrac14$ от тактовой частоты входного интерфейса FIFO.

Для корректной передачи и предотвращения потери данных, а также с целью борьбы с метастабильностью в случае независимых тактовых сигналов используются группа синхронизирующих триггеров, которые передают текущее состояние адреса чтения и адреса записи между клоковыми доменами. Основываясь на значениях данных адресов делается вывод о заполненности и пустоте очереди. 

\section{Адресация}

Адресация в памяти реализована с помощью двух пятиразрядных переменных, хранящих адрес ячеек,  с которыми будут произведены операции чтения и записи при следующем синхросигнале.

Важной частью работы устройства является работа с памятью. Необходимо избежать потери и перезаписи не переданных данных. С этой целью на каждом шаге работы схемы осуществляется проверка и сравнивание адресов чтения и записи.

Во время работы схема хранит адреса в виде рефлексивного двоичного кода Грея. Выбор в сторону кода Грея сделан для снижения критичности ошибки определения адреса чтения или записи при его передаче. 

В случае использования кода Грея при переходе к следующему адресу изменяется только один бит, и даже если схема не сможет верно определить значение адреса~---~посчитает, что адрес не изменился, это не приведет к нарушению работы системы. 

В то время как при использовании прямого двоичного кода ошибка синхронизации неизбежна. При переходе могут изменяться все биты адреса (например при переходе $01111 \to 1000$). В данном случае значение адреса является полностью неопределенным. Это может привести к нарушению в работе устройства в целом.

Когда указатели чтения и записи равны, это указывает на то, что FIFO пуст. Эта ситуация возникает во время операции сброса или когда было произведено чтение последнего слова в FIFO, как показано на Рисунке \ref{fig:empty-fifo}.

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{course-scheme/images/empty-fifo}
	\caption{Все данные прочитаны. Очередь пуста}
	\label{fig:empty-fifo}
\end{figure}

Когда указатели чтения и записи снова равны, это означает, что очередь заполнена и дальнейшая запись не может быть произведена. Эта ситуация возникает, когда переменная адреса записи переполняется, как показано на Рисунке \ref{fig:full-fifo}.

\begin{figure}[h!]
	\centering
	\includegraphics[width=0.7\linewidth]{course-scheme/images/full-fifo}
	\caption{Очередь заполнена. Запись не допустима}
	\label{fig:full-fifo}
\end{figure}

В обоих случаях адреса записи и чтения указывают на одну и ту же ячейку памяти, но при этом ситуации являются противоположными, что усложняет логику определения текущего состояния памяти цифрового устройства.

С целью определения текущего состояния асинхронной очереди необходимо использовать на один бит больше, чем требуется для адресации всех ячеек запоминающего устройства. Сравнение этого бита даст ответ о состоянии памяти в случае, когда указатели чтения и записи окажутся равны.

Пятиразрядные сигналы wr\_full и rd\_empty, позволяющие организовать корректную работу с устройством, формируются с помощью следующих логических условий.
\begin{align}
	 wr\_full = &\left(wptr  == \left\{!rptr[4:3],rptr[3:0]\right\}\right);\\
	 &rd\_empty = \left(wptr  == rptr\right)
\end{align}

В устройстве необходимо реализовать проверку обращения к одному элементу памяти. Чтение по данному адресу должно быть заблокировано до тех пор, пока адрес записи не перестанет указывать на данную ячейку памяти.

При каждом приходящем тактовом сигнале устройство осуществляет сравнение адресов чтения и записи, предварительно производя с ними промежуточные действия. Приведем список преобразований и производимых операций.

\begin{enumerate}
	\item Перевод из прямого двоичного кода в рефлексивный код Грея.
	\item Сохранение текущего значения в регистре.
	\item Передача значения адреса в синхронизационные регистры.
	\item Перевод из рефлексивного кода Грея в прямой двоичный код.
	\item Синхронизация приходящего адреса генератором соседнего домена. %синхронизации.
	\item Сравнение адресов чтения и записи.
\end{enumerate}

Данные операции производятся с адресом чтения и записи отдельно. Порядок следования этих операций можно пронаблюдать на Рисунке \ref{fig:signal-process}.

\begin{figure}
	\centering
	\includegraphics[width=1\linewidth]{course-scheme/images/signal-process}
	\caption{Обработка адресов чтения и записи}
	\label{fig:signal-process}
\end{figure}



\section{Функциональная схема}
Предлагается для построения устройства ресинхронизации данных, работающего в режиме очереди с независимыми тактовыми сигналами, использовать данную функциональную схему (см. Рисунок \ref{fig:unit-design}).

\begin{figure}[h!]
	\centering
	\includegraphics[width=1\linewidth]{course-scheme/images/unit-design}
	\caption{Функциональная схема устройства}
	\label{fig:unit-design}
\end{figure}


Приведем описание входов, выходов и служебных сигналов устройства (см. Таблицу \ref{tab:sig-ports}).

Также укажем используемые глобальные и локальные параметры, используемые при реализации устройства на языке описания аппаратуры Verilog (см. Таблицу \ref{tab:params}). С помощью данных параметров возможно произвести масштабирование устройства --- увеличить разрядность ячейки запоминающего устройства и их количество.

\begin{table}[htbp]
	\centering
	\fontsize{12}{16pt}\selectfont
	\caption{Параметры}
	\begin{tabular}{|l|p{0.5\linewidth}|c|}
		\hline
		\multicolumn{1}{|c}{\textbf{Название}} & \multicolumn{1}{|c|}{\textbf{Назначение}} & \multicolumn{1}{c|}{\textbf{Значение}} \\ \hline
		asize  &  разрядность адреса данных & 4 \\ \hline
		dsize  &  разрядность данных в битах & 8 \\ \hline
	\end{tabular}
	\label{tab:params}
\end{table}

Аппаратный блок по ресинхронизации данных разрабатывается для использования в совокупности с более сложными элементами и выполняет роль служебного блока хранения и передачи данных.



\begin{table}[h!]
	\fontsize{12}{16pt}\selectfont
	\centering
	\caption{Сигналы входы и выходы устройства}
	\label{tab:sig-ports}
	\begin{tabular}{|l|l|c|}
		\hline
		\multicolumn{1}{|c}{\textbf{Название}} & \multicolumn{1}{|c|}{\textbf{Назначение}} & \multicolumn{1}{c|}{\textbf{Разрядность}} \\ \hline
		mem  &  ячейки памяти очереди & [8:0] [0:15] \\ \hline
		rbin  &  текущий адрес чтения в бинарном коде & [4:0] \\ \hline
		rbinnext  &  адрес чтения в бинарном коде в следующем такте & [4:0] \\ \hline
		rclk  &  тактирование на чтение данных & 1 \\ \hline
		rdata  &  данные на чтение & [31:0] \\ \hline
		rden  &  разрешение на чтение & 1 \\ \hline
		rdredy  &  готовность выдать данные & 1 \\ \hline
		rempty  &  сигнал пустоты очереди (прочтено все, что записано) & 1 \\ \hline
		rempty\_next  &  пустота очереди на следующем такте & 1 \\ \hline
		rgray  &  текущий адрес чтения в коде Грея & [4:0] \\ \hline
		rgraynext  &  адрес чтения в коде Грея в следующем такте & [4:0] \\ \hline
		rq1\_wgray  &  адрес чтения в первом синхро-триггере & [4:0] \\ \hline
		rq2\_wgray  &  адрес чтения во втором синхро-триггере & [4:0] \\ \hline
		rrstn  &  сброс указателя чтения & 1 \\ \hline
		wbin  &  текущий адрес записи в бинарном коде & 1 \\ \hline
		wbinnext  &  адрес записи в бинарном коде в следующем такте & [4:0] \\ \hline
		wclk  &  Тактирование на запись данных & 1 \\ \hline
		wdata  &  данные на запись & [7:0] \\ \hline
		wfull  &  сигнал заполнения очереди & 1 \\ \hline
		wfull\_next  &  заполненность очереди на следующем такте & 1 \\ \hline
		wgray  &  текущий адрес записи в коде Грея & [4:0] \\ \hline
		wgraynext  &  адрес записи в коде Грея в следующем такте & [4:0] \\ \hline
		wq1\_rgray  &  адрес записи в первом синхро-триггере & [4:0] \\ \hline
		wq2\_rgray  &  адрес записи во втором синхро-триггере & [4:0] \\ \hline
		wren  &  разрешение на запись & 1 \\ \hline
		wrstn  &  сброc указателя записи & 1 \\ \hline
	\end{tabular}
\end{table}
\normalsize
\clearpage







\clearpage